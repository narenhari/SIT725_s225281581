<div class="schedules-page">
    <p class="schedules-intro">
        Manage your bedtime reminders and automated tasks
    </p>

    <div class="schedules-container">
            <section class="dash-card create-schedule-card">
                <div class="card-head">
                    <h3>Create New Schedule</h3>
                </div>
                <div class="card-body">
                    <form id="createScheduleForm">
                        <div class="field-group">
                            <label for="scheduleName">Schedule Name *</label>
                            <input type="text" id="scheduleName" name="name" placeholder="e.g., Bedtime Reminder" required/>
                        </div>
                        <div class="field-group">
                            <label for="scheduleType">Type *</label>
                            <select id="scheduleType" name="type" required>
                                <option value="bedtime">Bedtime (Simple)</option>
                                <option value="custom-cron">Custom Cron (Advanced)</option>
                            </select>
                        </div>
                        <div id="bedtimeFields" class="schedule-fields">
                            <div class="field-row">
                                <div class="field-group">
                                    <label for="bedtimeHour">Hour (0-23) *</label>
                                    <input type="number" id="bedtimeHour" name="hour" min="0" max="23" placeholder="22"/>
                                </div>
                                <div class="field-group">
                                    <label for="bedtimeMinute">Minute (0-59) *</label>
                                    <input type="number" id="bedtimeMinute" name="minute" min="0" max="59" placeholder="30"/>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Days of Week *</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" name="daysOfWeek" value="0"/> Sunday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="1"/> Monday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="2"/> Tuesday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="3"/> Wednesday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="4"/> Thursday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="5"/> Friday</label>
                                    <label><input type="checkbox" name="daysOfWeek" value="6"/> Saturday</label>
                                </div>
                            </div>
                        </div>
                        <div id="cronFields" class="schedule-fields" style="display: none;">
                            <div class="field-group">
                                <label for="customCron">Cron Expression *</label>
                                <input type="text" id="customCron" name="cron" placeholder="*/5 * * * * (every 5 mins)"/>
                                <small>Format: minute hour day month dayOfWeek</small>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button type="reset" class="btn-ghost">Clear</button>
                            <button type="submit" class="btn-primary">Create Schedule</button>
                        </div>
                    </form>
                </div>
            </section>

            <section class="dash-card schedules-list-card">
                <div class="card-head">
                    <h3>Your Sleep Schedules</h3>
                    <span class="count-badge" id="scheduleCount">0</span>
                </div>
                <div class="card-body">
                    <div id="schedulesLoadingSpinner" style="text-align: center; padding: 20px;">
                        <p>Loading schedules...</p>
                    </div>
                    <div id="schedulesContainer" style="display: none;">
                        <div id="noSchedulesMessage" style="text-align: center; padding: 20px; color: #999;">
                            No schedules yet. Create one above!
                        </div>
                        <table id="schedulesTable" style="display: none; width: 100%;" class="schedules-table">
                            <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Schedule</th>
                                <th>Last Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="schedulesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
</div>

<style>
    .schedules-page .schedules-intro {
        text-align: center;
        margin: 0 0 1.5rem;
        color: #555;
        font-size: 1.05rem;
    }

    .schedules-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .schedule-fields {
        margin: 20px 0;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 6px;
    }

    .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .schedules-table {
        border-collapse: collapse;
    }

    .schedules-table th, .schedules-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .schedules-table th {
        background: #f9f9f9;
        font-weight: 600;
        color: #333;
    }

    .schedules-table tbody tr:hover {
        background: #fafafa;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge.enabled {
        background: #d4edda;
        color: #155724;
    }

    .badge.disabled {
        background: #f8d7da;
        color: #721c24;
    }

    .count-badge {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
    }

    .btn-toggle {
        background: #17a2b8;
        color: white;
    }

    .btn-toggle:hover {
        background: #138496;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background: #c82333;
    }

    .last-run {
        font-size: 12px;
        color: #666;
    }

    .toast-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: #28a745;
        color: white;
        border-radius: 4px;
        z-index: 9999;
        animation: slideIn 0.3s ease-in-out;
    }

    .toast-message.error {
        background: #dc3545;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<script>
    (function () {
        const API_BASE = '/api/schedules';

        function initializeScheduleForm() {
            const now = new Date();
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const todayDay = now.getDay();
            document.getElementById('bedtimeHour').value = hour;
            document.getElementById('bedtimeMinute').value = minute;
            const dayCheckboxes = document.querySelectorAll('input[name="daysOfWeek"]');
            dayCheckboxes.forEach((checkbox, index) => {
                if (index === todayDay) {
                    checkbox.checked = true;
                    updateCheckboxLabel(checkbox);
                }
            });
            dayCheckboxes.forEach((cb) => cb.addEventListener('change', () => updateCheckboxLabel(cb)));
        }

        function updateCheckboxLabel(checkbox) {
            const label = checkbox.closest('label');
            if (checkbox.checked) {
                label.style.background = '#0a223d';
                label.style.color = '#fff';
                label.style.borderColor = '#0a223d';
                label.style.boxShadow = '0 4px 12px rgba(10, 34, 61, 0.2)';
            } else {
                label.style.background = '#f7fbff';
                label.style.color = '#000';
                label.style.borderColor = '#d8e7ff';
                label.style.boxShadow = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeScheduleForm();
            loadSchedules();
        });
        document.getElementById('scheduleType').addEventListener('change', function (e) {
            const isBedtime = e.target.value === 'bedtime';
            document.getElementById('bedtimeFields').style.display = isBedtime ? 'block' : 'none';
            document.getElementById('cronFields').style.display = isBedtime ? 'none' : 'block';
        });
        document.getElementById('createScheduleForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const type = document.getElementById('scheduleType').value;
            const name = document.getElementById('scheduleName').value;
            let payload = {name, type};
            if (type === 'bedtime') {
                const hour = parseInt(document.getElementById('bedtimeHour').value, 10);
                const minute = parseInt(document.getElementById('bedtimeMinute').value, 10);
                const daysOfWeek = Array.from(document.querySelectorAll('input[name="daysOfWeek"]:checked')).map(function (el) {
                    return parseInt(el.value, 10);
                });
                if (isNaN(hour) || isNaN(minute) || daysOfWeek.length === 0) {
                    showToast('Please fill in all bedtime fields', 'error');
                    return;
                }
                payload.timeOfDay = {hour, minute};
                payload.daysOfWeek = daysOfWeek;
            } else {
                const cron = document.getElementById('customCron').value;
                if (!cron) {
                    showToast('Please enter a cron expression', 'error');
                    return;
                }
                payload.cron = cron;
            }
            payload.enabled = true;
            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error && err.error.message ? err.error.message : 'Failed to create schedule');
                }
                showToast('Schedule created successfully!');
                document.getElementById('createScheduleForm').reset();
                loadSchedules();
            } catch (err) {
                showToast(err.message, 'error');
            }
        });

        async function loadSchedules() {
            try {
                document.getElementById('schedulesLoadingSpinner').style.display = 'block';
                document.getElementById('schedulesContainer').style.display = 'none';
                const response = await fetch(API_BASE, {credentials: 'include'});
                if (!response.ok) throw new Error('Failed to load schedules');
                const result = await response.json();
                const schedules = result.data && result.data.items ? result.data.items : [];
                document.getElementById('scheduleCount').textContent = schedules.length;
                document.getElementById('schedulesLoadingSpinner').style.display = 'none';
                document.getElementById('schedulesContainer').style.display = 'block';
                if (schedules.length === 0) {
                    document.getElementById('noSchedulesMessage').style.display = 'block';
                    document.getElementById('schedulesTable').style.display = 'none';
                    return;
                }
                document.getElementById('noSchedulesMessage').style.display = 'none';
                document.getElementById('schedulesTable').style.display = 'table';
                const tbody = document.getElementById('schedulesTableBody');
                tbody.innerHTML = schedules.map(function (s) {
                    const txt = s.type === 'bedtime' ? (String(s.timeOfDay.hour).padStart(2, '0') + ':' + String(s.timeOfDay.minute).padStart(2, '0') + ' on days ' + s.daysOfWeek.join(', ')) : ('Cron: ' + s.cron);
                    const lastRun = s.lastRunAt ? new Date(s.lastRunAt).toLocaleString() : 'Never';
                    return '<tr><td><strong>' + s.name + '</strong></td><td>' + s.type + '</td><td><small>' + txt + '</small></td><td><small class="last-run">' + lastRun + '</small></td><td><span class="badge ' + (s.enabled ? 'enabled' : 'disabled') + '">' + (s.enabled ? 'Enabled' : 'Disabled') + '</span></td><td><div class="action-buttons"><button class="btn-small btn-toggle" onclick="window.toggleSchedule(\'' + s._id + '\',' + !s.enabled + ')">' + (s.enabled ? 'Disable' : 'Enable') + '</button><button class="btn-small btn-delete" onclick="window.deleteSchedule(\'' + s._id + '\')">Delete</button></div></td></tr>';
                }).join('');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        window.toggleSchedule = async function (id, enabled) {
            fetch(API_BASE + '/' + id + '/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({enabled: enabled})
            }).then(function (r) {
                if (!r.ok) throw new Error('Failed to toggle');
                showToast(enabled ? 'Schedule enabled' : 'Schedule disabled');
                loadSchedules();
            }).catch(function (e) {
                showToast(e.message, 'error');
            });
        };
        window.deleteSchedule = async function (id) {
            if (!confirm('Are you sure you want to delete this schedule?')) return;
            fetch(API_BASE + '/' + id, {
                method: 'DELETE',
                credentials: 'include'
            }).then(function (r) {
                if (!r.ok) throw new Error('Failed to delete');
                showToast('Schedule deleted');
                loadSchedules();
            }).catch(function (e) {
                showToast(e.message, 'error');
            });
        };

        function showToast(message, type) {
            var t = document.createElement('div');
            t.className = 'toast-message' + (type === 'error' ? ' error' : '');
            t.textContent = message;
            document.body.appendChild(t);
            setTimeout(function () {
                t.remove();
            }, 3000);
        }
    })();
</script>
