name: CI & Staging Pipeline

on:
  push:
    branches:
      - testing

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_sha.outputs.sha_short }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get short SHA for image tag
        id: get_sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run unit tests
        run: |
          echo "Running tests..."
          # IMPORTANT: Replace this with your project's actual test command.
          echo "Tests passed!"

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      - name: Build and push Docker image
        run: |
          docker build . -t ${{ secrets.ACR_LOGIN_SERVER }}/my-app:${{ steps.get_sha.outputs.sha_short }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/my-app:${{ steps.get_sha.outputs.sha_short }}
####
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test-push
    environment: Staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR Login Server
        id: acr
        run: echo "server=$(az acr show --name narenacr722 --query loginServer --output tsv)" >> $GITHUB_OUTPUT

      - name: Get ACR Credentials
        id: acr_creds
        run: |
          ACR_USERNAME=$(az acr credential show --name narenacr722 --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name narenacr722 --query "passwords[0].value" -o tsv)
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.6.0'

      - name: Tofu Init
        run: tofu init
        working-directory: ./infra

      - name: Tofu Apply
        env:
          FULL_IMAGE_NAME: ${{ steps.acr.outputs.server }}/my-app:${{ needs.build-test-push.outputs.image_tag }}
        run: |
          # --- UPDATED TO PASS NEW CREDENTIAL VARIABLES ---
          tofu apply -auto-approve \
            -var="resource_group_name=${{ secrets.RESOURCE_GROUP_NAME }}" \
            -var="docker_image=${{ env.FULL_IMAGE_NAME }}" \
            -var="acr_username=${{ steps.acr_creds.outputs.username }}" \
            -var="acr_password=${{ steps.acr_creds.outputs.password }}"
        working-directory: ./infra

  destroy-staging:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.6.0'

      - name: Tofu Init
        run: tofu init
        working-directory: ./infra

      - name: Tofu Destroy
        run: tofu destroy -auto-approve
        working-directory: ./infra